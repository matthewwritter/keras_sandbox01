digraph G {
splines=polyline
node [shape=cds style=filled fillcolor=gray]

subgraph cluster_enc {
    subgraph cluster_enc {
        label = output
        color = black
        z_mean; z_var; z_sampled
    }

label = encoder
color = black
{indexed w2v} -> embedding -> flattened -> dense_enc -> {z_mean z_var} -> z_sampled

}

subgraph cluster_dec {
    label = decoder
    color = black
    dense_dec -> reshape_dec
}

temp [label= "outputs = decoder(encoder(inputs)[2])
vae = Model(inputs, outputs, name='vae')"]
temp2 [label="OPTIMIZATION LOOP\nreconstruction_loss = mse(K.flatten(flattened), K.flatten(outputs)" shape=oval style=filled fillcolor=yellow]

flattened -> temp2 -> reshape_dec [arrowhead=none style=dashed label="Same dims"]

z_sampled -> dense_dec

}